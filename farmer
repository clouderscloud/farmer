#!/bin/bash

#    Farmer - A lightweight automation tool built for Linux machines
#    Copyright (C) 2017  Manikumar Juttukonda <manikumar.juttukonda@gmail.com>
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

echo "
Farmer v0.0.1-alpha  Copyright (C) 2017  Manikumar Juttukonda
This program comes with ABSOLUTELY NO WARRANTY; for details type 'show w'.
This is free software, and you are welcome to redistribute it
under certain conditions; type 'show c' for details. 
"
echo "See <https://disizjay.github.io/farmer/> for more details."

#variables
pid=$$
whereami=`pwd`
home=${whereami}
cd ${home}; stat canal fruits soils seeds &>/dev/null; if [ $? -ne 0 ]; then echo -e "\nError: Required directories(canal, fruits, soils, seeds) are missing. Please make sure to clone most latest source"; exit 1; fi
umask 0027
seconds=0
canal_dir="${home}/canal";
fruits_dir="${home}/fruits";
soils_dir="${home}/soils";
seeds_dir="${home}/seeds";

#functions
function help() {
	echo -e "\nUsage: $0 [option] -user [username] -seed [seedname] -soil [soilname]"
	echo -e "\nOptions"
	echo -e "   info\t: Displays information about existing seeds and soils"
	echo -e "   sow\t: Start deployment. Requires additional parameters -user, -seed and -soil"
	echo -e "   help\t: Show this help"
	echo -e "\nAdditional Parameters"
	echo -e "   -user : Username used to perform action on remote hosts"
	echo -e "   -seed : Directory containing .plow files"
	echo -e "   -soil : Directory containing host groups"
	echo -e "\nExamples"
	echo -e "   To run deployment"
	echo -e "\t $0 sow -user root -seed install-webserver -soil development"
	echo -e "   To dislay information about existing configuration"
	echo -e "\t $0 info "
	echo -e "   For help"
	echo -e "\t $0 help"
	echo -e "   It is always recommended to run 'info' before running 'sow'"
	echo -e "\nSee <https://disizjay.github.io/farmer/> for updates, bug reports, and answers"
}

function farmer_info() {
	echo ""
	echo "Seed: $seed"
        echo "Soil: $soil"
	echo -e "\nSorry, farmer is not ready. Please check back later"
	exit 1
}

function farmer_sow() {
	echo ""
	echo "Seed: $seed"
	echo "Soil: $soil"
	echo -e "\nSorry, farmer is not ready. Please check back later"
	exit 1
}

#start
if [ $# -lt 1 ]; then
	echo ""
	echo "Error #101: Not enough arguments"
	help
	exit 1;
elif [ $# -gt 7 ]; then
	echo ""
	echo "Error #102: Too many aruments"
	help
	exit 1;
fi

case $1 in
	sow )
		if [ $# -ne 7 ]; then
			echo ""
			echo "Error #103: Incorrect usage for 'sow' operation"
			help
			exit 1;
		else
			case $2 in
				-user )
					remote_user=$3
					;;
				*)
					echo ""
                                        echo "Error #107: Incorrect usage for 'sow' operation"
                                        help
                                        exit 1;
                                        ;;
			esac
			case $4 in
				-seed )
					seed=$5
					if [[ ! -d "$seeds_dir/$seed" ]] || [[ ! -f `ls $seeds_dir/$seed/*.plow` ]]
                        		then
                                		echo ""
                                		echo "Error #104: Seed '$seed' do not exit or no .plow files found in seed"
                                		exit 1;
					fi
					;;
				*)
					echo ""
                                        echo "Error #104: Incorrect usage for 'sow' operation"
                                        help
                                        exit 1;
                                        ;;
			esac
			case $6 in
				-soil )
					soil=$7
					if [[ ! -d "$soils_dir/$soil" ]] || [[ ! -f "$soils_dir/$soil/hosts" ]]
                        		then
                                		echo ""
                                		echo "Error #105: Soil '$soil' do not exist or no hosts file found in soil"
                                		exit 1;
					fi
					;;
				*)
					echo ""
					echo "Error #105: Incorrect usage for 'sow' operation"
					help
					exit 1;
					;;
			esac
		
			#seed=$3
			#soil=$4
			#if [[ ! -d "$seeds_dir/$seed" ]] && [[ ! -f "$seeds_dir/$seed/*.plow" ]]
			#then
			#	echo ""
			#	echo "Error #104: Seed '$seed' do not exit or no .plow files found in seed"
			#	exit 1;
			#elif [[ ! -d "$soils_dir/$soil" ]] && [[ ! -f "$soils_dir/$soil/hosts" ]]
			#then
			#	echo ""
			#	echo "Error #105: Soil '$soil' do not exist or no hosts file found in soil"
			#	exit 1;
			#else
			farmer_info
			farmer_sow
			#fi
		fi
		;;
	
	info )
		farmer_info
		;;

	help )
		help
		exit 1;
		;;

	*)
		echo ""
		echo "Error #106: Usage error"
		help
		exit 1;
		;;
esac
#end
